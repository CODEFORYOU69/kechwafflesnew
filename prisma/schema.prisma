generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String               @id @default(cuid())
  name                    String
  email                   String               @unique
  emailVerified           Boolean              @default(false)
  image                   String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  role                    UserRole             @default(USER)
  registeredAt            DateTime?
  registeredForPronostics Boolean              @default(false)
  accounts                Account[]
  buteurTickets           ButeurTicket[]
  drawWinnings            DrawWinner[]
  finalPronostic          FinalPronostic?
  loyaltyPoints           LoyaltyTransaction[]
  memberCard              MemberCard?
  pronostics              Pronostic[]
  qrScans                 QRScan[]
  rewards                 Reward[]
  sessions                Session[]

  @@index([email])
  @@index([role])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  password              String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  accountId             String
  createdAt             DateTime  @default(now())
  idToken               String?
  providerId            String
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  ipAddress String?
  token     String   @unique
  updatedAt DateTime @updatedAt
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LoyverseConfig {
  id           String   @id @default("singleton")
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  storeId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Product {
  id             String           @id @default(cuid())
  handle         String           @unique
  sku            String           @unique
  name           String
  category       String
  description    String?
  image          String?
  price          Float?
  isModifier     Boolean          @default(false)
  hasTax         Boolean          @default(true)
  isActive       Boolean          @default(true)
  displayOrder   Int              @default(0)
  loyverseItemId String?          @unique
  lastSyncAt     DateTime?
  syncSource     String           @default("MANUAL")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  outOfStock     Boolean          @default(false)
  variants       ProductVariant[]

  @@index([category])
  @@index([isActive])
  @@index([displayOrder])
  @@index([loyverseItemId])
}

model ProductVariant {
  id                String   @id @default(cuid())
  productId         String
  option1Name       String?
  option1Value      String?
  option2Name       String?
  option2Value      String?
  price             Float
  variantSku        String?  @unique
  loyverseVariantId String?  @unique
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([loyverseVariantId])
}

model MemberCard {
  id                 String     @id @default(cuid())
  userId             String     @unique
  cardNumber         String     @unique
  qrCode             String     @unique
  totalPoints        Int        @default(0)
  currentPoints      Int        @default(0)
  totalSpent         Float      @default(0)
  visitCount         Int        @default(0)
  loyverseCustomerId String?    @unique
  lastSyncAt         DateTime?
  tier               MemberTier @default(BRONZE)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([cardNumber])
  @@index([qrCode])
  @@index([loyverseCustomerId])
}

model LoyaltyTransaction {
  id          String                 @id @default(cuid())
  userId      String
  type        LoyaltyTransactionType
  points      Int
  amount      Float?
  description String
  orderId     String?
  rewardId    String?
  createdAt   DateTime               @default(now())
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

model LoyaltyReward {
  id            String   @id @default(cuid())
  name          String
  description   String
  pointsCost    Int
  isActive      Boolean  @default(true)
  stockLimit    Int?
  currentStock  Int?
  image         String?
  expiresInDays Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Team {
  id                     String           @id @default(cuid())
  name                   String
  nameFr                 String
  nameAr                 String?
  code                   String           @unique
  flag                   String
  group                  String?
  firstPlacePredictions  FinalPronostic[] @relation("FirstPlace")
  secondPlacePredictions FinalPronostic[] @relation("SecondPlace")
  thirdPlacePredictions  FinalPronostic[] @relation("ThirdPlace")
  winnerPredictions      FinalPronostic[] @relation("WinnerPrediction")
  awayMatches            Match[]          @relation("AwayTeam")
  homeMatches            Match[]          @relation("HomeTeam")
  players                Player[]
}

model Match {
  id             String         @id @default(cuid())
  matchNumber    Int            @unique
  phase          MatchPhase
  homeTeamId     String
  awayTeamId     String
  scheduledAt    DateTime
  venue          String?
  city           String?
  homeScore      Int?
  awayScore      Int?
  isFinished     Boolean        @default(false)
  finishedAt     DateTime?
  lockPronostics Boolean        @default(false)
  buteurTickets  ButeurTicket[]
  awayTeam       Team           @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeTeam       Team           @relation("HomeTeam", fields: [homeTeamId], references: [id])
  pronostics     Pronostic[]

  @@index([scheduledAt])
  @@index([phase])
  @@index([isFinished])
}

model Pronostic {
  id              String   @id @default(cuid())
  userId          String
  matchId         String
  homeScore       Int
  awayScore       Int
  points          Int      @default(0)
  isExactScore    Boolean  @default(false)
  isCorrectWinner Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  match           Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, matchId])
  @@index([userId])
  @@index([matchId])
  @@index([points])
}

model FinalPronostic {
  id             String   @id @default(cuid())
  userId         String   @unique
  winnerTeamId   String
  finalHomeScore Int?
  finalAwayScore Int?
  firstPlaceId   String
  secondPlaceId  String
  thirdPlaceId   String
  bonusPoints    Int      @default(0)
  isLocked       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  firstPlace     Team     @relation("FirstPlace", fields: [firstPlaceId], references: [id])
  secondPlace    Team     @relation("SecondPlace", fields: [secondPlaceId], references: [id])
  thirdPlace     Team     @relation("ThirdPlace", fields: [thirdPlaceId], references: [id])
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  winnerTeam     Team     @relation("WinnerPrediction", fields: [winnerTeamId], references: [id])
}

model Reward {
  id          String     @id @default(cuid())
  userId      String
  type        RewardType
  description String
  code        String     @unique
  isRedeemed  Boolean    @default(false)
  redeemedAt  DateTime?
  redeemedBy  String?
  matchId     String?
  reason      String
  createdAt   DateTime   @default(now())
  expiresAt   DateTime
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([isRedeemed])
  @@index([expiresAt])
}

model Competition {
  id                      String    @id @default(cuid())
  name                    String    @default("CAN 2025")
  startDate               DateTime
  endDate                 DateTime
  isActive                Boolean   @default(true)
  lockFinalPronostics     Boolean   @default(false)
  finalPronosticsDeadline DateTime
  actualWinnerId          String?
  actualSecondId          String?
  actualThirdId           String?
  finalHomeScore          Int?
  finalAwayScore          Int?
  grandPrixWinnerId       String?
  grandPrixDrawnAt        DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model ConcoursRegistrationQR {
  id        String   @id @default(cuid())
  qrCode    String   @unique
  qrCodeUrl String
  isActive  Boolean  @default(true)
  scanCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([qrCode])
}

model DailyQRCode {
  id        String   @id @default(cuid())
  qrCode    String   @unique
  qrCodeUrl String
  validDate DateTime @db.Date
  isActive  Boolean  @default(true)
  scanCount Int      @default(0)
  createdAt DateTime @default(now())
  scans     QRScan[]

  @@index([validDate])
  @@index([qrCode])
}

model QRScan {
  id          String      @id @default(cuid())
  userId      String
  qrCodeId    String
  scannedAt   DateTime    @default(now())
  hasAccess   Boolean     @default(true)
  dailyQRCode DailyQRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, qrCodeId])
  @@index([userId])
  @@index([scannedAt])
}

model Player {
  id       String         @id @default(cuid())
  name     String
  nameFr   String
  number   Int?
  position String?
  teamId   String
  goals    Int            @default(0)
  tickets  ButeurTicket[]
  team     Team           @relation(fields: [teamId], references: [id])

  @@index([teamId])
}

model ButeurTicket {
  id         String    @id @default(cuid())
  ticketCode String    @unique
  userId     String?
  matchId    String
  playerId   String
  hasWon     Boolean   @default(false)
  isChecked  Boolean   @default(false)
  prizeType  String?
  prizeValue Float?
  isRedeemed Boolean   @default(false)
  redeemedAt DateTime?
  isPrinted  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  match      Match     @relation(fields: [matchId], references: [id])
  player     Player    @relation(fields: [playerId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])

  @@index([ticketCode])
  @@index([userId])
  @@index([matchId])
  @@index([hasWon])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Partner {
  id               String       @id @default(cuid())
  name             String
  description      String
  logo             String?
  address          String?
  phone            String?
  email            String?
  website          String?
  tier             PartnerTier  @default(BRONZE)
  prizeTitle       String
  prizeDescription String?
  prizeValue       Float?
  prizeImage       String?
  prizeQuantity    Int          @default(1)
  isActive         Boolean      @default(true)
  isVisible        Boolean      @default(true)
  displayOrder     Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  drawWinners      DrawWinner[]

  @@index([tier])
  @@index([isActive])
  @@index([displayOrder])
}

model WeeklyDraw {
  id                String       @id @default(cuid())
  weekNumber        Int
  year              Int
  startDate         DateTime     @db.Date
  endDate           DateTime     @db.Date
  drawType          DrawType     @default(WEEKLY)
  isCompleted       Boolean      @default(false)
  drawnAt           DateTime?
  totalParticipants Int          @default(0)
  totalScans        Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  winners           DrawWinner[]

  @@unique([year, weekNumber, drawType])
  @@index([weekNumber, year])
  @@index([isCompleted])
}

model DrawWinner {
  id               String     @id @default(cuid())
  drawId           String
  userId           String
  position         Int
  prizeType        String
  prizeTitle       String
  prizeDescription String?
  prizeValue       Float?
  prizeImage       String?
  partnerId        String?
  notified         Boolean    @default(false)
  notifiedAt       DateTime?
  isClaimed        Boolean    @default(false)
  claimedAt        DateTime?
  scanCount        Int        @default(0)
  createdAt        DateTime   @default(now())
  draw             WeeklyDraw @relation(fields: [drawId], references: [id], onDelete: Cascade)
  partner          Partner?   @relation(fields: [partnerId], references: [id])
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([drawId])
  @@index([userId])
  @@index([isClaimed])
}

enum UserRole {
  USER
  ADMIN
}

enum MemberTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyTransactionType {
  PURCHASE
  REWARD_REDEEMED
  BONUS
  CONTEST_WIN
  MANUAL_ADJUSTMENT
}

enum MatchPhase {
  GROUP_STAGE
  ROUND_OF_16
  QUARTER_FINAL
  SEMI_FINAL
  THIRD_PLACE
  FINAL
}

enum RewardType {
  CAFE_GRATUIT
  GAUFRE_GRATUITE
  TIRAGE_GRAND_PRIX
}

enum PartnerTier {
  PREMIUM
  GOLD
  SILVER
  BRONZE
}

enum DrawType {
  WEEKLY
  GRAND_PRIZE
}
